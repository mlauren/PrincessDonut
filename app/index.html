<!-- index.html -->
<!doctype html>
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">

  <meta name="description" content="Princess Simon is here to listen to your words."/>

  <meta property="og:type" content="profile" />
  <meta property="og:title" content="http://princesssimon.info/" />
  <meta property="og:description" content="Princess Simon is here to listen to your words."/>
  <meta property="og:image" content = "http://princesssimon.info/img/hiSimon.jpg">
  <link rel="publisher" href="http://plus.google.com/u/1/117967543269457019554/"/>
  <meta name="twitter:card" content="summary">
  <meta name="twitter:description" content="Princess Simon is here to listen to your words.">
  <meta name="twitter:image" content="http://princesssimon.info/img/hiSimon.jpg">
  <base href="/" />

  <!-- SCROLLS -->
  <!-- load bootstrap and fontawesome via CDN -->
  <link rel="stylesheet" href="//netdna.bootstrapcdn.com/bootstrap/3.0.0/css/bootstrap.min.css" />
  <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/font-awesome/4.5.0/css/font-awesome.min.css">
  <link rel="stylesheet" href="styles.css"></script>

  <style>
    a {color:#bb8de2;}
    body {
      color: #888888;
      font-family:Monospace;
      font-size:13px;

      background-color: #000;
      margin: 0px;
      overflow: hidden;
    }
    #info {
      position: absolute;
      top: 0px;
      width: 300px;
      left: calc(50% - 100px);
      text-align: center;
    }
    #webgl {
      margin-top:20px;
    }
    .loading {
      font-size: 16px;
    }

    .loading:after {
      overflow: hidden;
      display: inline-block;
      vertical-align: bottom;
      -webkit-animation: ellipsis steps(4,end) 900ms infinite;
      animation: ellipsis steps(4,end) 900ms infinite;
      content: "\2026"; /* ascii code for the ellipsis character */
      width: 0px;
    }

    @keyframes ellipsis {
      to {
        width: 1.25em;
      }
    }

    @-webkit-keyframes ellipsis {
      to {
        width: 1.25em;
      }
    }
  </style>

  
</head>
<body>
  <div id="container"><div id="info">
      <span id="loading" class="loading">The princess is getting ready ⋛⋋( ‘Θ’)⋌⋚</span>
    </div></div>
  <div id="webgl"></div>
  
  <!-- SPELLS -->
  <script type="text/javascript" src="//cdnjs.cloudflare.com/ajax/libs/jquery/2.1.4/jquery.min.js"></script>
  <script src="bower_components/three.js/three.js"></script>
  <script src="bower_components/jsSHA/src/sha1.js"></script>
  <script src="bower_components/tween.js/src/Tween.js"></script>
  <script src="bower_components/stats.js/src/Stats.js"></script>
  <script src="scripts/detector.js"></script>
  <script src="scripts/trackBallControls.js"></script>
  <script src="/socket.io/socket.io.js"></script>
  <script type="text/javascript">
    /* Set up Socket.io */
    console.log(window.location.href);
  </script>
  <script type="text/javascript">

    var socket = io.connect('http://localhost:3001/',{reconnect: true});
    console.log(socket);
    $(document).on('ready', function() {
      (function() { 

        socket.on('connect', function () {
          console.log('connect');
          init();
          render();
        });

        var camera, controls, scene, mesh, renderer, stats, tween, font = undefined, textGeo, textMesh1;
        /* Set up initial text vars */
        var text = "Tweet @SimonHi",
            height = 1,
            size = 1,
            hover = 3,
            curveSegments = 5;

        function init() {

          THREE.DefaultLoadingManager.onProgress = function ( item, loaded, total ) {
              console.log( item, loaded, total );
            if (loaded == total) {
              var loadingDiv = document.getElementById("loading");
              loadingDiv.style.display = "none";
            }
          };

          var webglEl = document.getElementById('webgl'); 

          if (!Detector.webgl) {
            Detector.addGetWebGLMessage(webglEl);
          }

          THREE.ImageUtils.crossOrigin = '';

          var width = window.innerWidth,
              height = window.innerHeight;

          var radius=0.45,
              segments=32,
              rotation=5;

          scene = new THREE.Scene();


          camera = new THREE.PerspectiveCamera(45, width / height, 0.05, 1000);

          camera.position.z = 15;
          camera.position.y = 2;
          camera.position.x = 2;

          renderer = new THREE.WebGLRenderer();

          renderer.setSize(width, height);
          scene.add(new THREE.AmbientLight(0x502c5f));

          var light = new THREE.DirectionalLight(0xffffff, .5);

          light.position.set(2, 3, 9);
          scene.add(light);

          var loader = new THREE.JSONLoader(); // init the loader util
          // init loading
          loader.load('models/paraqueet.json', function (geometry) {

            var materialTexture = new THREE.MeshPhongMaterial( { fog: false } );

            // Create a mesh with models geometry and material
            mesh = new THREE.Mesh(
              geometry,
              materialTexture
            );

            mesh.position.x = 0;
            mesh.position.y = 0;
            mesh.position.z = 0;

            mesh.name = "simon";
            mesh.scale.set( 1, 1, 1 );

            scene.add(mesh);

            socket.on('tweetmedia', function (data) {
              //console.log(data.message.media_url);

              var simon = scene.getObjectByName( "simon", true );

              // console.log(simon);
              simon.material.map = THREE.ImageUtils.loadTexture( data.message.media_url );
              simon.material.needsUpdate = true;

            });
          });

          // console.log(scene);

          /* Set up font material */
          material = new THREE.MultiMaterial( [
            new THREE.MeshPhongMaterial( { color: 0xffffff, shading: THREE.FlatShading, transparent: true, opacity: .2 } ), // front
            new THREE.MeshPhongMaterial( { color: 0xffffff, shading: THREE.SmoothShading, transparent: true, opacity: .2  } ) // side
          ] );

          /* Set up font Group */
          group = new THREE.Group();
          group.position.y = 0;

          scene.add( group );

          /* Load the fonts */
          loadFont();

          //* Take tweet and spit out text *//
          socket.on('tweet', function (data) {
            console.log(data);
            text = data.message;
            loadFont();

          });

          /* Load the stars */
          var stars = createStars(90, 64);

          scene.add(stars);

          controls = new THREE.TrackballControls(camera);

          webglEl.appendChild(renderer.domElement);

          // tween.start();
          // init the Stats and append it to the Dom - performance vuemeter
          stats = new Stats();
          stats.domElement.style.position = 'absolute';
          stats.domElement.style.top = '0px';
          container.appendChild( stats.domElement );
        }

        function loadFont() {
          loader = new THREE.FontLoader();
          loader.load( 'fonts/Montserrat_Bold.typeface.js', function ( response ) {
            // console.log(response);
            font = response;

            createText();

          });

        }

        function createText() {
          group.remove( textMesh1 );
          textGeo = new THREE.TextGeometry( text, {

            font: font,

            size: size,
            height: height,
            curveSegments: curveSegments,

            material: 0,
            extrudeMaterial: 1

          });

          textGeo.computeBoundingBox();
          textGeo.computeVertexNormals();

          var centerOffset = -0.5 * ( textGeo.boundingBox.max.x - textGeo.boundingBox.min.x );

          textMesh1 = new THREE.Mesh( textGeo, material );

          textMesh1.position.x = centerOffset;
          textMesh1.position.y = hover;
          textMesh1.position.z = 0;

          textMesh1.rotation.x = 0;
          textMesh1.rotation.y = Math.PI * 2;

          new TWEEN.Tween( textMesh1.material.materials[0] ).to( { opacity: 1 }, 3000 ).start();
          new TWEEN.Tween( textMesh1.material.materials[1] ).to( { opacity: 1 }, 3000 ).start();

          group.add( textMesh1 );
        }

        function render() {
          controls.update();

          requestAnimationFrame(render);
          renderer.render(scene, camera); 
          
          stats.update();
          // update the tweens from TWEEN library
          TWEEN.update();

        }

        function createStars(radius, segments) { 
          return new THREE.Mesh(new THREE.SphereGeometry(radius, segments, segments), new THREE.MeshBasicMaterial({ map: THREE.ImageUtils.loadTexture('img/galaxy_starfield.jpg'), side: THREE.BackSide })); 
        } 
      }());
    });
  </script>
</body>
</html>